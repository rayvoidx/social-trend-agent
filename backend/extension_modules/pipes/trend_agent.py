"""
ì†Œë¹„ì íŠ¸ë Œë“œ ìë™ ë¶„ì„ ì—ì´ì „íŠ¸ Pipe

ì´ ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
1. ë‰´ìŠ¤ ë° ì†Œì…œ ë¯¸ë””ì–´ ë°ì´í„° ìë™ ìˆ˜ì§‘
2. ê°ì„± ë¶„ì„ (ê¸ì •/ë¶€ì •/ì¤‘ë¦½)
3. ì£¼ìš” í‚¤ì›Œë“œ ë° íŠ¸ë Œë“œ ì¶”ì¶œ
4. ì¢…í•© ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
"""

from typing import Union, Dict, Any, Generator, Iterator
from pydantic import BaseModel, Field
from extension_modules.pipes.base import ReactAgentBasePipe
from extension_modules.tools.trend_analysis import TrendAnalysisTool
import os


class Pipe(ReactAgentBasePipe):
    """ì†Œë¹„ì íŠ¸ë Œë“œ ë¶„ì„ ì—ì´ì „íŠ¸"""

    class Valves(BaseModel):
        """ì—ì´ì „íŠ¸ ì„¤ì • (Valves)"""

        # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
        SYSTEM_PROMPT: str = Field(
            default="""ë‹¹ì‹ ì€ **ì†Œë¹„ì íŠ¸ë Œë“œ ë¶„ì„ ì „ë¬¸ê°€ AI ì—ì´ì „íŠ¸**ì…ë‹ˆë‹¤.

## ì£¼ìš” ì—­í• 
- ì‹ ì œí’ˆ ë° ê¸°ì¡´ ì œí’ˆì— ëŒ€í•œ ì‹œì¥ ë°˜ì‘ ì‹¤ì‹œê°„ ë¶„ì„
- ì˜¨ë¼ì¸ ë‰´ìŠ¤, SNS, ì»¤ë®¤ë‹ˆí‹° ë°ì´í„° ê¸°ë°˜ íŠ¸ë Œë“œ íŒŒì•…
- ê°ì„± ë¶„ì„ì„ í†µí•œ ì†Œë¹„ì ë°˜ì‘ ì¸¡ì •
- ë§ˆì¼€íŒ… ë° ìƒí’ˆ ê¸°íšíŒ€ì˜ ì˜ì‚¬ê²°ì • ì§€ì›

## ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬
1. **search_news**: íŠ¹ì • í‚¤ì›Œë“œë¡œ ìµœì‹  ë‰´ìŠ¤ ê²€ìƒ‰
   - ì œí’ˆëª…, ë¸Œëœë“œëª…, ì‚°ì—… íŠ¸ë Œë“œ ë“±ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
   - ê²€ìƒ‰ ê¸°ê°„(days)ê³¼ ê²°ê³¼ ìˆ˜(max_results)ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

2. **analyze_sentiment**: í…ìŠ¤íŠ¸ ê°ì„± ë¶„ì„
   - ë‰´ìŠ¤, ë¦¬ë·°, ëŒ“ê¸€ ë“±ì˜ ê°ì„±(ê¸ì •/ë¶€ì •/ì¤‘ë¦½)ì„ ë¶„ì„í•©ë‹ˆë‹¤
   - ì „ì²´ ìš”ì•½ ë˜ëŠ” ê°œë³„ í…ìŠ¤íŠ¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤

3. **extract_keywords**: ì£¼ìš” í‚¤ì›Œë“œ ì¶”ì¶œ
   - í…ìŠ¤íŠ¸ì—ì„œ ìì£¼ ì–¸ê¸‰ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤
   - íŠ¸ë Œë“œ ë° ì£¼ëª©ë°›ëŠ” ì£¼ì œë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

4. **summarize_trend**: ì¢…í•© íŠ¸ë Œë“œ ë¶„ì„
   - ë‰´ìŠ¤ ìˆ˜ì§‘, ê°ì„± ë¶„ì„, í‚¤ì›Œë“œ ì¶”ì¶œì„ í†µí•©í•œ ì¢…í•© ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
   - ì „ì²´ì ì¸ ì‹œì¥ ë™í–¥ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

5. **web_search**: ì›¹ ê²€ìƒ‰ (í™œì„±í™” ì‹œ)
   - ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•  ë•Œ ì›¹ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤

## ì‘ì—… í”„ë¡œì„¸ìŠ¤
1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ë„êµ¬ë¥¼ ì„ íƒí•©ë‹ˆë‹¤
2. í•„ìš”í•œ ê²½ìš° ì—¬ëŸ¬ ë„êµ¬ë¥¼ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤
3. ë¶„ì„ ê²°ê³¼ë¥¼ êµ¬ì¡°í™”í•˜ì—¬ ëª…í™•í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤
4. í•µì‹¬ ì¸ì‚¬ì´íŠ¸ì™€ ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤

## ì‘ë‹µ ê°€ì´ë“œë¼ì¸
- **ëª…í™•ì„±**: ë°ì´í„° ê¸°ë°˜ì˜ ê°ê´€ì ì¸ ë¶„ì„ ì œê³µ
- **êµ¬ì¡°í™”**: ì„¹ì…˜ë³„ë¡œ ì •ë¦¬ëœ ê²°ê³¼ ì œì‹œ (ê°ì„± ë¶„ì„, í‚¤ì›Œë“œ, ì¸ì‚¬ì´íŠ¸ ë“±)
- **ì‹¤ìš©ì„±**: ë§ˆì¼€íŒ… ë° ê¸°íšíŒ€ì´ ì‹¤ì œë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì¸ì‚¬ì´íŠ¸ ì œê³µ
- **ì‹œê°í™”**: ê°€ëŠ¥í•œ ê²½ìš° ìˆ˜ì¹˜ì™€ ë¹„ìœ¨ì„ ëª…ì‹œí•˜ì—¬ ì´í•´ë„ í–¥ìƒ

## ì‘ë‹µ í˜•ì‹ ì˜ˆì‹œ
```
### ğŸ“Š ë¶„ì„ ê²°ê³¼ ìš”ì•½

**ë¶„ì„ ëŒ€ìƒ**: [ì œí’ˆëª…/ì£¼ì œ]
**ë¶„ì„ ê¸°ê°„**: ìµœê·¼ [N]ì¼
**ìˆ˜ì§‘ ë°ì´í„°**: [N]ê±´ì˜ ë‰´ìŠ¤/ë¦¬ë·°

### ğŸ¯ ê°ì„± ë¶„ì„
- ê¸ì •: XX%
- ì¤‘ë¦½: XX%
- ë¶€ì •: XX%

### ğŸ”‘ ì£¼ìš” í‚¤ì›Œë“œ
1. [í‚¤ì›Œë“œ1]
2. [í‚¤ì›Œë“œ2]
3. [í‚¤ì›Œë“œ3]

### ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸
- [ì¸ì‚¬ì´íŠ¸ 1]
- [ì¸ì‚¬ì´íŠ¸ 2]
- [ì¸ì‚¬ì´íŠ¸ 3]

### ğŸ“ ê¶Œì¥ ì‚¬í•­
- [ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ 1]
- [ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ 2]
```

ì§€ê¸ˆë¶€í„° ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ íŠ¸ë Œë“œ ë¶„ì„ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.""",
            description="ì—ì´ì „íŠ¸ì˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤. ì—ì´ì „íŠ¸ì˜ ì—­í• ê³¼ í–‰ë™ì„ ì •ì˜í•©ë‹ˆë‹¤."
        )

        # ëª¨ë¸ ì„¤ì •
        MODEL_TYPE: str = Field(
            default="azure",
            description="ì‚¬ìš©í•  LLM ëª¨ë¸ íƒ€ì… (í˜„ì¬ëŠ” azureë§Œ ì§€ì›)"
        )

        TEMPERATURE: float = Field(
            default=0.1,
            description="LLM Temperature (0.0-2.0). ë‚®ì„ìˆ˜ë¡ ì¼ê´€ëœ ì‘ë‹µ, ë†’ì„ìˆ˜ë¡ ì°½ì˜ì ì¸ ì‘ë‹µ"
        )

        # ë©”ì‹œì§€ ì„¤ì •
        AGENT_START_MESSAGE: str = Field(
            default="íŠ¸ë Œë“œ ë¶„ì„ ì—ì´ì „íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...",
            description="ì—ì´ì „íŠ¸ ì‹œì‘ ì‹œ í‘œì‹œë˜ëŠ” ë©”ì‹œì§€"
        )

        AGENT_END_MESSAGE: str = Field(
            default="ëª¨ë“  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
            description="ì—ì´ì „íŠ¸ ì¢…ë£Œ ì‹œ í‘œì‹œë˜ëŠ” ë©”ì‹œì§€"
        )

        AGENT_ERROR_MESSAGE: str = Field(
            default="ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:",
            description="ì˜¤ë¥˜ ë°œìƒ ì‹œ í‘œì‹œë˜ëŠ” ë©”ì‹œì§€"
        )

    def __init__(self):
        """Pipe ì´ˆê¸°í™”"""
        # Valves ì´ˆê¸°í™”
        valves = self.Valves()

        # ë„êµ¬ ì´ˆê¸°í™”
        tool = TrendAnalysisTool()

        # LLM ëª¨ë¸ ì´ˆê¸°í™” (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        model = self._get_model(
            model_type=valves.MODEL_TYPE,
            temperature=valves.TEMPERATURE
        )

        # ë¶€ëª¨ í´ë˜ìŠ¤ ì´ˆê¸°í™”
        super().__init__(
            model=model,
            tool=tool,
            valves=valves,
            agent_start_message=valves.AGENT_START_MESSAGE,
            agent_end_message=valves.AGENT_END_MESSAGE,
            agent_error_message=valves.AGENT_ERROR_MESSAGE
        )

    def pipe(
        self,
        body: dict,
        __user__: dict = None,
        __event_emitter__=None,
        __metadata__=None,
        __task__=None,
        __request__=None
    ) -> Union[str, Dict[str, Any], Generator, Iterator]:
        """
        Pipe ì‹¤í–‰ (Open WebUI ì¸í„°í˜ì´ìŠ¤)

        Args:
            body: ìš”ì²­ ë³¸ë¬¸ (messages í¬í•¨)
            __user__: ì‚¬ìš©ì ì •ë³´
            __event_emitter__: ì´ë²¤íŠ¸ ë°œí–‰ê¸° (status, citation ë“±)
            __metadata__: ë©”íƒ€ë°ì´í„° (features ë“±)
            __task__: ì‘ì—… íƒ€ì…
            __request__: HTTP ìš”ì²­ ê°ì²´

        Returns:
            ìƒì„±ëœ ì‘ë‹µ (ìŠ¤íŠ¸ë¦¬ë°)
        """
        return self._pipe(
            body=body,
            __user__=__user__,
            __event_emitter__=__event_emitter__,
            __metadata__=__metadata__,
            __task__=__task__,
            __request__=__request__
        )
